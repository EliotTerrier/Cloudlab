import sys, socket, os, signal
import threading
import time
import requests
import xml.etree.ElementTree as ET
from datetime import datetime
from zeroconf_publish import publish_service

MCAST_GRP = '239.255.42.21'
MULTICAST_TTL = 2
DATA_TEMPLATE_XML="GNSSLocationDelivery.xml"

#gnsslocation service parameters 
name = "ITxPT_gnsslocation"
ipaddress = "10.0.9.227"
port = 14005
service_type = "_itxpt_multicast._udp.local."
properties = {
	'txtvers': '1',
	'version': '2.2.1',
    'multicast': MCAST_GRP
}

killService = False
filename="/home/eliot/Documents/cloudlab/GNSSLocationDelivery.xml"
xmlTree=""

def publish_zeroconf_service():  
	threading.Thread(target=publish_service, daemon=True, args=(name, service_type, ipaddress, port, properties)).start() # daemon=True to exit the subscrption process when the flask server is stopped


def exit_gracefully(signum,frame):
    global killService
    killService = True

def changeXMLData(xml:ET.ElementTree,longitude,latitude):
     xml.find("GNSSLocation/Data").text="" #empty data string 
     currentdate=datetime.today()
     xml.find("GNSSLocation/Latitude/Degree").text="48.877583"
     xml.find("GNSSLocation/Longitude/Degree").text=f"{longitude:.6f}" #update longitude value 
     xml.find("GNSSLocation/Time").text=currentdate.strftime("%H:%M:%S")
     xml.find("GNSSLocation/Date").text=currentdate.strftime("%Y-%m-%d")
     return ET.tostring(xml.getroot(),encoding="utf-8",xml_declaration=True) #converting the modified XML document back to a bytes-like object 


def gnsslocation_daemon(ipaddress,port,xmlData):
    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, socket.IPPROTO_UDP)
    sock.setsockopt(socket.IPPROTO_IP, socket.IP_MULTICAST_TTL, MULTICAST_TTL)
    # limit multicast to a specific interface
    sock.setsockopt(socket.IPPROTO_IP, socket.IP_MULTICAST_IF, socket.inet_aton(ipaddress))
    sock.sendto(bytearray(xmlData), (MCAST_GRP, port))

def background_job():
        global killService
        global xmlTree
        global port
        global ipaddress

        print("GNSSLocation server started and delivering UDP packets to multicast group")
        publish_zeroconf_service()
        longitude=2.338950
        while not killService:
                time.sleep(1)
                xmlData=changeXMLData(xmlTree,longitude,0)
                longitude+=1E-6 #going east every second
                print(xmlData)
                gnss_thread = threading.Thread(target=gnsslocation_daemon, name='Thread-gnss_thread',kwargs={"ipaddress":ipaddress,"port":port,"xmlData":xmlData})
                gnss_thread.daemon = True
                gnss_thread.start()
        if  gnss_thread!=None and gnss_thread.is_alive():
            gnss_thread.join()
        print("Service terminated gracefully.")

     
# main 
if __name__ == '__main__':
    xmlTree = ET.parse(filename)
    signal.signal(signal.SIGINT, exit_gracefully)
    signal.signal(signal.SIGTERM, exit_gracefully)
    background_job()
    
